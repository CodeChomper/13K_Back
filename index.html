<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        canvas {
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
            width: 800px;
            height: 400px;
        }
        #ins{
            text-align: center;
            color: Red;
        }
    </style>
</head>

<body>
    <br/>
    <div id=ins>
        <h3>
        Use left and right arrows to rotate forward and BACK-wards to avoid the blocks.
    </h3>
            </div>
    
    <canvas id="canvas" style="border: 1px solid black;" />
    
    
    <script>

        function ang2Rad(ang) {
            return ang * (Math.PI / 180);
        }

        const Player = function (x, y) {
            this.x = x;
            this.y = y;
            this.g = 40;
            this.a = 0;
            this.s = 6;
            this.clockWise = true;
            this.update = function () {
                if (keys.left && !keys.right) {
                    this.clockWise = false;
                }
                if (keys.right && !keys.left) {
                    this.clockWise = true;
                }

                if (!pause) this.a += this.clockWise ? this.s % 360 : -this.s % 360;
            };
            this.draw = function () {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(ang2Rad(this.a));
                ctx.fillStyle = "rgb(0,0,255)";
                ctx.translate(-this.x, -this.y);
                ctx.fillRect(this.x - 10, this.y - this.g - 5, 20, 10);
                ctx.fillRect(this.x - 10, this.y + this.g - 5, 20, 10);
                //ctx.fillRect(this.x - 3, this.y - 3, 6, 6);
                ctx.restore();
            };
        }

        const Block = function (maxSpeed) {
            
            this.maxSpeed = maxSpeed;
            this.s = Math.random() * maxSpeed + 1;
            this.h = Math.random() * 10 + 5;
            this.w = Math.random() * 20 + 10;
            this.x = c.width + 2* this.w * level;
            this.y = Math.random() * (c.height - this.h);
            
            this.update = function () {
                if (!pause) this.x -= this.s;
                
                if(this.x + this.w < 0){
                    score++;
                    this.x = c.width;
                    this.s = Math.random() * this.maxSpeed + 1;
                    this.h = Math.random() * 10 + 5;
                    this.w = Math.random() * 20 + 10;
                    this.y = Math.random() * (c.height - this.h);
                }
            };
            
            this.draw = function () {
                ctx.fillStyle = "Red";
                ctx.fillRect(this.x, this.y, this.w, this.h);
            };
            
            this.checkCollision = function(){
                // check for hit underneath
                var data = ctx.getImageData(this.x, this.y, this.w, this.h);

                var hit = false;
                for (var i = 0; i < data.data.length; i += 4) {
                    if (data.data[i] == 0 && data.data[i + 1] == 0 && data.data[i + 2] == 255) {
                        console.log("HIT YO!!!");
                        hit = true;
                    }
                }
                return hit;
            };
        }

        

        function kDown(e) {
            if (e.code == "ArrowLeft") {
                keys.left = true;
            }
            if (e.code == "ArrowRight") {
                keys.right = true;
            }

            pause = false;
        }

        function kUp(e) {
            if (e.code == "ArrowLeft")
                keys.left = false;
            if (e.code == "ArrowRight")
                keys.right = false;
            

        }

        window.onload = function () {

            
            level = 1;
            gameState = 0
            pause = false;
            console.log("Window Loaded");
            c = document.getElementById("canvas");
            ctx = c.getContext("2d");
            p = new Player(50, c.height / 2);
            keys = { left: false, right: false };
            document.addEventListener('keydown', kDown);
            document.addEventListener('keyup', kUp);
            c.addEventListener("mouseup", canvasClicked);
            setInterval(update, 1000 / 30);
            
        }
        
        function canvasClicked(e){
            if(gameState ==0){
                startGame();
                gameState++;
            } else if(gameState == 1){
                // This has an issue when a block gets stuck deep under the player
                //p.clockWise = !p.clockWise;
                //pause = false;
            }
        }
        
        function startGame(){
            
            score = 0;
            b = [];
            for(var i=0; i<level; i++){
                b.push(new Block(level*1.2));
            }
        }

        function update() {
            switch(gameState){
                case 0:
                    ctx.fillStyle = "black";
                    ctx.fillRect(0,0,c.width,c.height);
                    ctx.fillStyle = "White";
                    ctx.fillText("Click to Start",120, 100);
                    break;
                case 1:
                    //Go up a level
                    if(score > level * 3){
                        level++;
                        startGame();
                    }
                    ctx.fillStyle = "Black";
                    ctx.fillRect(0, 0, c.width, c.height);
                    ctx.fillStyle = "White";
                    ctx.fillText("Score: " + score, 10,20);
                    p.update();
                    p.draw();
                    for(var i=0; i<b.length; i++){
                
                        if(b[i].checkCollision()){
                            pause = true;
                        
                        }
                        b[i].update();
                        b[i].draw();    
                    }
                    break;
            }
            
            
            
        }
    </script>
</body>

</html>
